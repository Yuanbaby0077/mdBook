# Vue 模板编译

## 挂载

挂载的过程就是： 获取挂载点，编译模板，将编译后的模板通过render函数处理成虚拟DOM，再通过update方法将虚拟DOM转为真实的DOM

实现挂载的步骤：

* 定义挂载方法：`Vue.prototype.$mount`
```
Vue.prototype.$mount = function (
    el,
    hydrating
  ) {
    el = el && inBrowser ? query(el) : undefined;
    return mountComponent(this, el, hydrating)
  };
```
* 缓存原型上的`mount`方法：`var mount = Vue.prototype.$mount;`

* 重新定义`Vue.prototype.$mount`方法
```
Vue.prototype.$mount = function (
    el,
    hydrating
  ) {
    el = el && query(el);
    /* istanbul ignore if */
    // 挂载的元素不能是body 和 html 根节点
    if (el === document.body || el === document.documentElement) {
      warn(
        "Do not mount Vue to <html> or <body> - mount to normal elements instead."
      );
      return this
    }

    var options = this.$options;
    // resolve template/el and convert to render function
    // 如果没有render函数，意味着可能是template模板
    if (!options.render) {
      var template = options.template;
      if (template) {
        if (typeof template === 'string') {
          if (template.charAt(0) === '#') {
            template = idToTemplate(template);
            /* istanbul ignore if */
            if (!template) {
              warn(
                ("Template element not found or is empty: " + (options.template)),
                this
              );
            }
          }
        } else if (template.nodeType) { // 如果模板是元素节点
          template = template.innerHTML;
        } else {
          {
            warn('invalid template option:' + template, this);
          }
          return this
        }
      } else if (el) {
        // 如果没有传入模板，默认以el元素为根元素作为模板
        template = getOuterHTML(el);
      }
      if (template) {
        /* istanbul ignore if */
        if (config.performance && mark) {
          mark('compile');
        }

        var ref = compileToFunctions(template, {
          outputSourceRange: "development" !== 'production',
          shouldDecodeNewlines: shouldDecodeNewlines,
          shouldDecodeNewlinesForHref: shouldDecodeNewlinesForHref,
          delimiters: options.delimiters,
          comments: options.comments
        }, this);
        var render = ref.render;
        var staticRenderFns = ref.staticRenderFns;
        options.render = render;
        options.staticRenderFns = staticRenderFns;

        /* istanbul ignore if */
        if (config.performance && mark) {
          mark('compile end');
          measure(("vue " + (this._name) + " compile"), 'compile', 'compile end');
        }
      }
    }
    // 最终 无论是模板编译还是render函数，都要执行挂载函数
    // 该mount是缓存的方法:   var mount = Vue.prototype.$mount;
    return mount.call(this, el, hydrating)
  };
```
* 最终无论是模板编译还是手写render函数都要执行缓存的`mount`函数

```
function mountComponent (
    vm,
    el,
    hydrating
  ) {
    vm.$el = el;
    callHook(vm, 'beforeMount');

    updateComponent = function () {
      // render函数渲染成虚拟DOM，虚拟DOM转换为真实DOM。
      vm._update(vm._render(), hydrating);
    };
    在watcher构造函数中调用updateComponent函数。
    new Watcher(vm, updateComponent, noop, {
      before: function before () {
        if (vm._isMounted && !vm._isDestroyed) {
          callHook(vm, 'beforeUpdate');
        }
      }
    }, true /* isRenderWatcher */);
    hydrating = false;

    // manually mounted instance, call mounted on self
    // mounted is called for render-created child components in its inserted hook
    if (vm.$vnode == null) {
      vm._isMounted = true;
      callHook(vm, 'mounted');
    }
    return vm
  }
```